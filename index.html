<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Quinta dos Porcos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f0f0; min-height: 100vh; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, #2d5016 0%, #4a7c23 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.5rem; }
        .alertas { padding: 10px; }
        .alerta { background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 8px; border-radius: 8px; }
        .alerta.urgente { background: #f8d7da; border-left-color: #dc3545; }
        .alerta.pronta { background: #d1ecf1; border-left-color: #17a2b8; }
        .alerta.recuperacao { background: #d4edda; border-left-color: #28a745; }
        .alerta.atribuir { background: #e1bee7; border-left-color: #9c27b0; }
        .despesa-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #dc3545; }
        .despesa-card .valor { font-size: 1.3rem; font-weight: bold; color: #dc3545; }
        .despesa-card .categoria { font-size: 0.8rem; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; display: inline-block; }
        .despesa-card .data { font-size: 0.85rem; color: #999; }
        .financeiro-resumo { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .financeiro-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .financeiro-card.receita { border-top: 4px solid #28a745; }
        .financeiro-card.despesa { border-top: 4px solid #dc3545; }
        .financeiro-card.lucro { border-top: 4px solid #007bff; }
        .financeiro-card .valor { font-size: 1.8rem; font-weight: bold; }
        .financeiro-card.receita .valor { color: #28a745; }
        .financeiro-card.despesa .valor { color: #dc3545; }
        .financeiro-card.lucro .valor { color: #007bff; }
        .financeiro-card.lucro.negativo .valor { color: #dc3545; }
        .financeiro-card .label { font-size: 0.9rem; color: #666; margin-top: 5px; }
        .btn-alerta { margin-top: 10px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: bold; cursor: pointer; display: block; }
        .btn-alerta.purple { background: #9c27b0; }
        .container { padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; }
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: #2d5016; }
        .card-info { color: #666; font-size: 0.9rem; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; color: white; }
        .badge-jovem { background: #6c757d; }
        .badge-disponivel { background: #28a745; }
        .badge-gravida { background: #ffc107; color: #333; }
        .badge-amamentacao { background: #e83e8c; }
        .badge-recuperacao { background: #17a2b8; }
        .badge-sem-numero { background: #9c27b0; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { flex: 1; padding: 10px 5px; text-align: center; border: none; background: none; cursor: pointer; color: #666; font-size: 0.65rem; }
        .nav-item.active { color: #2d5016; }
        .nav-item span { display: block; font-size: 1.2rem; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #2d5016; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-purple { background: #9c27b0; color: white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto; }
        .modal-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .section-title { font-size: 1.2rem; font-weight: bold; margin: 20px 0 10px; color: #2d5016; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .empty span { font-size: 3rem; display: block; margin-bottom: 10px; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #2d5016; color: white; border: none; font-size: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 90; }
        .hidden { display: none !important; }
        .evento-adicionar { border-left: 4px solid #28a745; }
        .evento-cobricao { border-left: 4px solid #ffc107; }
        .evento-parto { border-left: 4px solid #e83e8c; }
        .evento-desmame { border-left: 4px solid #17a2b8; }
        .evento-matadouro { border-left: 4px solid #dc3545; }
        .evento-disponivel { border-left: 4px solid #28a745; }
        .evento-recuperacao { border-left: 4px solid #17a2b8; }
        .evento-venda { border-left: 4px solid #28a745; }
        .stat-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-titulo { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; color: #2d5016; }
        .stat-numero { font-size: 2.5rem; font-weight: bold; color: #2d5016; text-align: center; margin: 10px 0; }
        .stat-label { text-align: center; color: #666; font-size: 0.9rem; }
        .barra-container { margin: 10px 0; }
        .barra-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .barra-fundo { background: #e9ecef; border-radius: 10px; height: 25px; overflow: hidden; }
        .barra-valor { height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.8rem; font-weight: bold; min-width: 30px; }
        .barra-verde { background: #28a745; }
        .barra-amarela { background: #ffc107; color: #333; }
        .barra-rosa { background: #e83e8c; }
        .barra-azul { background: #17a2b8; }
        .barra-cinza { background: #6c757d; }
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .resumo-parto { background: #f8f9fa; border-radius: 8px; padding: 12px; margin: 15px 0; }
        .resumo-parto .linha { display: flex; justify-content: space-between; margin: 5px 0; }
        .resumo-parto .total { border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold; }
        .leitao-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .leitao-card.sem-numero { border-left: 4px solid #9c27b0; }
        .leitao-info { flex: 1; }
        .leitao-genero { font-size: 1.5rem; margin-right: 10px; }
        .leitao-checkbox { width: 24px; height: 24px; }
        .filtro-container { margin-bottom: 15px; }
        .filtro-container select { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem; }
        .leitao-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; }
        .leitao-item input { width: 80px; }
        .offline-banner { background: #dc3545; color: white; text-align: center; padding: 10px; display: none; }
        .offline-banner.show { display: block; }
    </style>
</head>
<body>
    <div id="offline-banner" class="offline-banner">‚ö†Ô∏è Sem liga√ß√£o</div>
    <div class="header"><h1>üê∑ Quinta dos Porcos</h1></div>

    <div id="pagina-alertas" class="pagina"><div class="alertas" id="lista-alertas"><div class="empty"><span>‚è≥</span>A carregar...</div></div></div>
    <div id="pagina-porcas" class="pagina hidden"><div class="container"><div class="filtro-container"><select id="filtro-porcas" onchange="filtrarPorcas()"><option value="todas">Todas</option><option value="Cima">Cima (Jovens)</option><option value="Cobricao">Cobri√ß√£o</option><option value="Parideiras">Parideiras</option><option value="Disponivel">Dispon√≠veis</option><option value="Gravida">Gr√°vidas</option><option value="Amamentacao">Amamenta√ß√£o</option><option value="Recuperacao">Recupera√ß√£o</option></select></div><div id="lista-porcas"></div></div><button class="fab" onclick="abrirModalNovaPorca()">+</button></div>
    <div id="pagina-varroes" class="pagina hidden"><div class="container"><div id="lista-varroes"></div></div><button class="fab" onclick="abrirModalNovoVarrao()">+</button></div>
    <div id="pagina-leitoes" class="pagina hidden"><div class="container"><div id="lista-leitoes"></div><button class="btn btn-success" onclick="abrirModalVenderLeitoes()" id="btn-vender-leitoes" style="display:none;">üí∞ Vender</button></div></div>
    <div id="pagina-stats" class="pagina hidden"><div class="container"><div class="grid-stats"><div class="stat-card"><div class="stat-numero" id="stat-total-porcas">0</div><div class="stat-label">Porcas</div></div><div class="stat-card"><div class="stat-numero" id="stat-total-varroes">0</div><div class="stat-label">Varr√µes</div></div></div><div class="stat-card"><div class="stat-titulo">Estados das Porcas</div><div id="barras-estados"></div></div><div class="stat-card"><div class="stat-titulo">Leit√µes</div><div class="stat-numero" id="stat-total-leitoes">0</div><div class="stat-label">atualmente</div></div></div></div>
    <div id="pagina-financeiro" class="pagina hidden"><div class="container"><div class="financeiro-resumo"><div class="financeiro-card receita"><div class="valor" id="total-receitas">‚Ç¨0</div><div class="label">Receitas</div></div><div class="financeiro-card despesa"><div class="valor" id="total-despesas">‚Ç¨0</div><div class="label">Despesas</div></div></div><div class="financeiro-card lucro" id="card-lucro"><div class="valor" id="total-lucro">‚Ç¨0</div><div class="label">Lucro/Preju√≠zo</div></div><h3 class="section-title">Despesas Recentes</h3><div id="lista-despesas"></div><button class="btn btn-danger" onclick="abrirModalNovaDespesa()">+ Nova Despesa</button></div></div>
    <div id="pagina-historico" class="pagina hidden"><div class="container"><div id="lista-historico"></div></div></div>

    <nav class="nav">
        <button class="nav-item active" onclick="mudarPagina('alertas')"><span>üîî</span>Alertas</button>
        <button class="nav-item" onclick="mudarPagina('porcas')"><span>üê∑</span>Porcas</button>
        <button class="nav-item" onclick="mudarPagina('varroes')"><span>üêó</span>Varr√µes</button>
        <button class="nav-item" onclick="mudarPagina('leitoes')"><span>üêΩ</span>Leit√µes</button>
        <button class="nav-item" onclick="mudarPagina('stats')"><span>üìä</span>Stats</button>
        <button class="nav-item" onclick="mudarPagina('financeiro')"><span>üí∞</span>‚Ç¨</button>
        <button class="nav-item" onclick="mudarPagina('historico')"><span>üìú</span>Hist√≥rico</button>
    </nav>

    <div id="modal-nova-porca" class="modal"><div class="modal-content"><div class="modal-title">Adicionar Porca</div><div class="form-group"><label>N√∫mero</label><input type="number" id="nova-porca-num"></div><div class="form-group"><label>Pocilga</label><select id="nova-porca-pocilga"><option value="Cima">Cima (Jovem)</option><option value="Cobricao">Cobri√ß√£o (Dispon√≠vel)</option></select></div><div class="form-group"><label>Nascimento</label><input type="date" id="nova-porca-data"></div><button class="btn btn-primary" onclick="adicionarPorca()">Adicionar</button><button class="btn btn-secondary" onclick="fecharModal('modal-nova-porca')">Cancelar</button></div></div>
    <div id="modal-novo-varrao" class="modal"><div class="modal-content"><div class="modal-title">Adicionar Varr√£o</div><div class="form-group"><label>N√∫mero</label><input type="number" id="novo-varrao-num"></div><div class="form-group"><label>Estado</label><select id="novo-varrao-estado"><option value="Jovem">Jovem</option><option value="Disponivel">Dispon√≠vel</option></select></div><div class="form-group"><label>Nascimento</label><input type="date" id="novo-varrao-data"></div><button class="btn btn-primary" onclick="adicionarVarrao()">Adicionar</button><button class="btn btn-secondary" onclick="fecharModal('modal-novo-varrao')">Cancelar</button></div></div>
    <div id="modal-porca" class="modal"><div class="modal-content"><div class="modal-title" id="modal-porca-titulo">Porca #</div><div id="modal-porca-info"></div><div id="modal-porca-acoes"></div><button class="btn btn-secondary" onclick="fecharModal('modal-porca')">Fechar</button></div></div>
    <div id="modal-varrao" class="modal"><div class="modal-content"><div class="modal-title" id="modal-varrao-titulo">Varr√£o #</div><div id="modal-varrao-info"></div><div id="modal-varrao-acoes"></div><button class="btn btn-secondary" onclick="fecharModal('modal-varrao')">Fechar</button></div></div>
    <div id="modal-cobricao" class="modal"><div class="modal-content"><div class="modal-title">Registar Cobri√ß√£o</div><input type="hidden" id="cobricao-porca-num"><div class="form-group"><label>Varr√£o</label><select id="cobricao-varrao"></select></div><button class="btn btn-warning" onclick="registarCobricao()">Registar</button><button class="btn btn-secondary" onclick="fecharModal('modal-cobricao')">Cancelar</button></div></div>
    <div id="modal-parto" class="modal"><div class="modal-content"><div class="modal-title">Registar Parto</div><input type="hidden" id="parto-porca-num"><h4 style="margin:15px 0 10px;color:#dc3545;">üè∑Ô∏è Leit√µes para VENDER</h4><div id="parto-vender-container"></div><button type="button" class="btn btn-warning" onclick="adicionarLeitaoVender()" style="margin-top:10px;">+ Vender</button><h4 style="margin:20px 0 10px;color:#28a745;">üè† Leit√µes para FICAR</h4><div id="parto-ficar-container"></div><button type="button" class="btn btn-info" onclick="adicionarLeitaoFicar()" style="margin-top:10px;">+ Ficar</button><div class="resumo-parto" id="resumo-parto"></div><button class="btn btn-primary" onclick="registarParto()">Registar Parto</button><button class="btn btn-secondary" onclick="fecharModal('modal-parto')">Cancelar</button></div></div>
    <div id="modal-desmame" class="modal"><div class="modal-content"><div class="modal-title">Registar Desmame</div><input type="hidden" id="desmame-porca-num"><p style="margin-bottom:15px;color:#666;">Atribui n√∫meros aos leit√µes que ficam:</p><div id="desmame-leitoes-container"></div><div style="background:#fff3cd;padding:10px;border-radius:8px;margin:15px 0;"><small>‚ö†Ô∏è F√™meas ‚Üí Porcas jovens | Machos ‚Üí Varr√µes jovens</small></div><button class="btn btn-info" onclick="confirmarDesmame()">Confirmar Desmame</button><button class="btn btn-secondary" onclick="fecharModal('modal-desmame')">Cancelar</button></div></div>
    <div id="modal-vender-leitoes" class="modal"><div class="modal-content"><div class="modal-title">Vender Leit√µes</div><p id="vender-leitoes-info"></p><div class="form-group"><label>Valor (‚Ç¨)</label><input type="number" id="vender-leitoes-valor" step="0.01"></div><button class="btn btn-success" onclick="confirmarVendaLeitoes()">Confirmar</button><button class="btn btn-secondary" onclick="fecharModal('modal-vender-leitoes')">Cancelar</button></div></div>
    <div id="modal-atribuir-numero" class="modal"><div class="modal-content"><div class="modal-title">Atribuir N√∫mero</div><input type="hidden" id="atribuir-leitao-id"><p id="atribuir-leitao-info"></p><div class="form-group"><label>N√∫mero</label><input type="number" id="atribuir-numero"></div><button class="btn btn-purple" onclick="confirmarAtribuirNumero()">Atribuir</button><button class="btn btn-secondary" onclick="fecharModal('modal-atribuir-numero')">Cancelar</button></div></div>
    <div id="modal-nova-despesa" class="modal"><div class="modal-content"><div class="modal-title">Nova Despesa</div><div class="form-group"><label>Categoria</label><select id="despesa-categoria"><option value="Alimentacao">Alimenta√ß√£o</option><option value="Veterinario">Veterin√°rio</option><option value="Equipamento">Equipamento</option><option value="Manutencao">Manuten√ß√£o</option><option value="Outros">Outros</option></select></div><div class="form-group"><label>Descri√ß√£o</label><input type="text" id="despesa-descricao"></div><div class="form-group"><label>Valor (‚Ç¨)</label><input type="number" id="despesa-valor" step="0.01"></div><button class="btn btn-danger" onclick="adicionarDespesa()">Adicionar</button><button class="btn btn-secondary" onclick="fecharModal('modal-nova-despesa')">Cancelar</button></div></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_ToriWPqYJ3ELzzRkIXpRoyAjA3Fk5xI",
            authDomain: "gestao-dos-porcos.firebaseapp.com",
            databaseURL: "https://gestao-dos-porcos-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestao-dos-porcos",
            storageBucket: "gestao-dos-porcos.firebasestorage.app",
            messagingSenderId: "973161258767",
            appId: "1:973161258767:web:8bb5f9e6bf9bb98fae287a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dados = { porcas: [], varroes: [], leitoes: [], historico: [], despesas: [], proximoIdLeitao: 1, proximoIdDespesa: 1 };
        let leitoesSelecionados = [];

        function carregarDados() {
            db.ref('quinta').on('value', (s) => {
                const v = s.val();
                if (v) dados = { porcas: v.porcas||[], varroes: v.varroes||[], leitoes: v.leitoes||[], historico: v.historico||[], despesas: v.despesas||[], proximoIdLeitao: v.proximoIdLeitao||1, proximoIdDespesa: v.proximoIdDespesa||1 };
                atualizarUI();
            });
        }
        function guardarDados() { return db.ref('quinta').set(dados); }
        function mudarPagina(p) { document.querySelectorAll('.pagina').forEach(x=>x.classList.add('hidden')); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); document.getElementById('pagina-'+p).classList.remove('hidden'); event.target.closest('.nav-item').classList.add('active'); atualizarUI(); }
        function fecharModal(id) { document.getElementById(id).classList.remove('active'); }
        function hoje() { return new Date().toISOString().split('T')[0]; }
        function formatarData(d) { return d ? new Date(d).toLocaleDateString('pt-PT') : '-'; }
        function diasEntre(a,b) { return Math.floor((new Date(b)-new Date(a))/(1000*60*60*24)); }
        function adicionarDias(d,n) { const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().split('T')[0]; }
        
        function getEstadoLabel(p) {
            const t = p.estado?.tipo || p.estado;
            switch(t) {
                case 'Jovem': return {texto:'Jovem',classe:'badge-jovem'};
                case 'Disponivel': return {texto:'Dispon√≠vel',classe:'badge-disponivel'};
                case 'Gravida': return {texto:`Gr√°vida (${formatarData(p.estado.dataParto)})`,classe:'badge-gravida'};
                case 'Amamentacao': return {texto:`Amamenta√ß√£o (${formatarData(p.estado.dataDesmame)})`,classe:'badge-amamentacao'};
                case 'Recuperacao': return {texto:`Recupera√ß√£o (${formatarData(p.estado.dataFim)})`,classe:'badge-recuperacao'};
                default: return {texto:t||'?',classe:'badge-jovem'};
            }
        }
        function getEstadoVarraoLabel(v) { return (v.estado==='Jovem') ? {texto:'Jovem',classe:'badge-jovem'} : {texto:'Dispon√≠vel',classe:'badge-disponivel'}; }
        function getPocilgaLabel(p) { return p==='Cima'?'Pocilga de Cima':p==='Cobricao'?'Cobri√ß√£o':p==='Parideiras'?'Parideiras':p; }

        function gerarAlertas() {
            const alertas = [], h = hoje();
            dados.porcas.forEach(p => {
                const e = p.estado?.tipo || p.estado;
                if (e==='Gravida' && p.estado.dataParto) { const d=diasEntre(h,p.estado.dataParto); if(d<=7&&d>=0) alertas.push({tipo:'parto',mensagem:`Porca ${p.num} perto de parir`,dias:d,num:p.num,classe:d<=3?'urgente':''}); }
                if (e==='Amamentacao' && p.estado.dataDesmame) { const d=diasEntre(h,p.estado.dataDesmame); if(d<=7&&d>=0) alertas.push({tipo:'desmame',mensagem:`Porca ${p.num} perto de desmamar`,dias:d,num:p.num,classe:d<=3?'urgente':''}); }
                if (e==='Recuperacao' && p.estado.dataFim) { const d=diasEntre(h,p.estado.dataFim); if(d<=3&&d>=0) alertas.push({tipo:'recuperacao',mensagem:`Porca ${p.num} termina recupera√ß√£o`,dias:d,num:p.num,classe:'recuperacao'}); }
                if (p.numPartos>=8) alertas.push({tipo:'velha',mensagem:`Porca ${p.num} para matadouro (${p.numPartos} partos)`,num:p.num,classe:'urgente'});
                if (e==='Jovem' && p.dataNascimento && diasEntre(p.dataNascimento,h)>=240) alertas.push({tipo:'pronta',mensagem:`Porca ${p.num} pronta para reproduzir`,num:p.num,classe:'pronta'});
            });
            dados.leitoes.filter(l=>l.destino==='Ficar'&&!l.numeroAtribuido).forEach(l => alertas.push({tipo:'atribuir',mensagem:`Leit√£o #${l.idLeitao} (${l.genero==='Macho'?'‚ôÇ':'‚ôÄ'}) precisa de n√∫mero`,idLeitao:l.idLeitao,classe:'atribuir'}));
            return alertas;
        }

        function renderizarAlertas() {
            const c = document.getElementById('lista-alertas'), a = gerarAlertas();
            if (a.length===0) { c.innerHTML='<div class="empty"><span>‚úÖ</span>Sem alertas!</div>'; return; }
            c.innerHTML = a.map(x=>`<div class="alerta ${x.classe}"><strong>${x.mensagem}</strong>${x.dias!==undefined?`<br><small>${x.dias} dias</small>`:''}${x.tipo==='pronta'?`<button class="btn-alerta" onclick="tornarDisponivel(${x.num})">Tornar Dispon√≠vel</button>`:''}${x.tipo==='recuperacao'?`<button class="btn-alerta" onclick="terminarRecuperacao(${x.num})">Terminar Recupera√ß√£o</button>`:''}${x.tipo==='atribuir'?`<button class="btn-alerta purple" onclick="abrirModalAtribuirNumero(${x.idLeitao})">Atribuir N√∫mero</button>`:''}</div>`).join('');
        }

        function renderizarPorcas() {
            const c = document.getElementById('lista-porcas'), f = document.getElementById('filtro-porcas').value;
            let ps = dados.porcas;
            if (f!=='todas') ps = dados.porcas.filter(p => (f==='Cima'||f==='Cobricao'||f==='Parideiras') ? p.pocilga===f : (p.estado?.tipo||p.estado)===f);
            if (ps.length===0) { c.innerHTML='<div class="empty"><span>üê∑</span>Nenhuma porca</div>'; return; }
            c.innerHTML = ps.map(p => { const e=getEstadoLabel(p); return `<div class="card" onclick="abrirModalPorca(${p.num})"><div class="card-title">Porca #${p.num}</div><div class="card-info"><span class="badge ${e.classe}">${e.texto}</span><br><small>${getPocilgaLabel(p.pocilga)} ‚Ä¢ ${p.numPartos} partos</small></div></div>`; }).join('');
        }
        function filtrarPorcas() { renderizarPorcas(); }

        function abrirModalNovaPorca() { document.getElementById('nova-porca-num').value=''; document.getElementById('nova-porca-pocilga').value='Cima'; document.getElementById('nova-porca-data').value=''; document.getElementById('modal-nova-porca').classList.add('active'); }
        function adicionarPorca() {
            const n=parseInt(document.getElementById('nova-porca-num').value), p=document.getElementById('nova-porca-pocilga').value, d=document.getElementById('nova-porca-data').value||null;
            if (!n) { alert('Introduz n√∫mero'); return; }
            if (dados.porcas.find(x=>x.num===n)) { alert('J√° existe'); return; }
            dados.porcas.push({num:n,pocilga:p,estado:p==='Cima'?'Jovem':'Disponivel',numPartos:0,dataNascimento:d,ultimoVarrao:null});
            dados.historico.unshift({data:hoje(),tipo:'EventoAdicionar',descricao:`Porca ${n} adicionada`,numPorca:n});
            guardarDados().then(()=>{fecharModal('modal-nova-porca');alert('Porca adicionada!');});
        }

        function abrirModalPorca(n) {
            const p = dados.porcas.find(x=>x.num===n); if(!p)return;
            const e = getEstadoLabel(p), t = p.estado?.tipo||p.estado;
            document.getElementById('modal-porca-titulo').textContent=`Porca #${p.num}`;
            document.getElementById('modal-porca-info').innerHTML=`<div class="card"><p><strong>Pocilga:</strong> ${getPocilgaLabel(p.pocilga)}</p><p><strong>Estado:</strong> <span class="badge ${e.classe}">${e.texto}</span></p><p><strong>Partos:</strong> ${p.numPartos}</p>${p.dataNascimento?`<p><strong>Nasc:</strong> ${formatarData(p.dataNascimento)}</p>`:''}${p.ultimoVarrao?`<p><strong>√öltimo varr√£o:</strong> #${p.ultimoVarrao}</p>`:''}</div>`;
            let a = '';
            if (t==='Jovem') a+=`<button class="btn btn-success" onclick="tornarDisponivel(${n})">Tornar Dispon√≠vel</button>`;
            if (t==='Disponivel') a+=`<button class="btn btn-warning" onclick="abrirModalCobricao(${n})">Registar Cobri√ß√£o</button>`;
            if (t==='Gravida') a+=`<button class="btn btn-primary" onclick="abrirModalParto(${n})">Registar Parto</button>`;
            if (t==='Amamentacao') a+=`<button class="btn btn-info" onclick="abrirModalDesmame(${n})">Registar Desmame</button>`;
            if (t==='Recuperacao') a+=`<button class="btn btn-success" onclick="terminarRecuperacao(${n})">Terminar Recupera√ß√£o</button>`;
            a+=`<button class="btn btn-danger" onclick="removerPorca(${n})">Enviar Matadouro</button>`;
            document.getElementById('modal-porca-acoes').innerHTML=a;
            document.getElementById('modal-porca').classList.add('active');
        }

        function tornarDisponivel(n) { const i=dados.porcas.findIndex(x=>x.num===n); if(i===-1)return; dados.porcas[i].estado='Disponivel'; dados.porcas[i].pocilga='Cobricao'; dados.historico.unshift({data:hoje(),tipo:'EventoDisponivel',descricao:`Porca ${n} dispon√≠vel`,numPorca:n}); guardarDados().then(()=>{fecharModal('modal-porca');alert('Dispon√≠vel!');}); }
        function terminarRecuperacao(n) { const i=dados.porcas.findIndex(x=>x.num===n); if(i===-1)return; dados.porcas[i].estado='Disponivel'; dados.porcas[i].pocilga='Cobricao'; dados.historico.unshift({data:hoje(),tipo:'EventoRecuperacao',descricao:`Porca ${n} recuperada`,numPorca:n}); guardarDados().then(()=>{fecharModal('modal-porca');alert('Recuperada!');}); }
        function removerPorca(n) { if(!confirm(`Enviar Porca ${n} para matadouro?`))return; dados.porcas=dados.porcas.filter(x=>x.num!==n); dados.historico.unshift({data:hoje(),tipo:'EventoMatadouro',descricao:`Porca ${n} para matadouro`,numPorca:n}); guardarDados().then(()=>{fecharModal('modal-porca');alert('Removida.');}); }

        function abrirModalCobricao(n) {
            document.getElementById('cobricao-porca-num').value=n;
            const vs = dados.varroes.filter(v=>v.estado!=='Jovem');
            document.getElementById('cobricao-varrao').innerHTML=vs.map(v=>`<option value="${v.numVarrao}">Varr√£o #${v.numVarrao}</option>`).join('');
            if (vs.length===0) { alert('Sem varr√µes dispon√≠veis!'); return; }
            fecharModal('modal-porca'); document.getElementById('modal-cobricao').classList.add('active');
        }
        function registarCobricao() {
            const np=parseInt(document.getElementById('cobricao-porca-num').value), nv=parseInt(document.getElementById('cobricao-varrao').value);
            const i=dados.porcas.findIndex(x=>x.num===np); if(i===-1)return;
            const dp = adicionarDias(hoje(),114);
            dados.porcas[i].estado={tipo:'Gravida',dataParto:dp,varrao:nv}; dados.porcas[i].ultimoVarrao=nv; dados.porcas[i].pocilga='Cobricao';
            dados.historico.unshift({data:hoje(),tipo:'EventoCobricao',descricao:`Porca ${np} coberta por Varr√£o ${nv}`,numPorca:np,numVarrao:nv});
            guardarDados().then(()=>{fecharModal('modal-cobricao');alert(`Cobri√ß√£o! Parto: ${formatarData(dp)}`);});
        }

        function abrirModalParto(n) { document.getElementById('parto-porca-num').value=n; document.getElementById('parto-vender-container').innerHTML=''; document.getElementById('parto-ficar-container').innerHTML=''; atualizarResumoParto(); fecharModal('modal-porca'); document.getElementById('modal-parto').classList.add('active'); }
        function adicionarLeitaoVender() { const c=document.getElementById('parto-vender-container'),i=c.children.length; const d=document.createElement('div'); d.className='leitao-item'; d.innerHTML=`<span>üè∑Ô∏è #${i+1}</span><select class="leitao-vender-genero"><option value="Macho">‚ôÇ</option><option value="Femea">‚ôÄ</option></select><button type="button" onclick="this.parentElement.remove();atualizarResumoParto();" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:5px;">‚úï</button>`; c.appendChild(d); atualizarResumoParto(); }
        function adicionarLeitaoFicar() { const c=document.getElementById('parto-ficar-container'),i=c.children.length; const d=document.createElement('div'); d.className='leitao-item'; d.innerHTML=`<span>üè† #${i+1}</span><select class="leitao-ficar-genero"><option value="Macho">‚ôÇ</option><option value="Femea">‚ôÄ</option></select><button type="button" onclick="this.parentElement.remove();atualizarResumoParto();" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:5px;">‚úï</button>`; c.appendChild(d); atualizarResumoParto(); }
        function atualizarResumoParto() { const v=document.querySelectorAll('.leitao-vender-genero').length, f=document.querySelectorAll('.leitao-ficar-genero').length; document.getElementById('resumo-parto').innerHTML=`<div class="linha"><span>Vender:</span><span>${v}</span></div><div class="linha"><span>Ficar:</span><span>${f}</span></div><div class="linha total"><span>Total:</span><span>${v+f}</span></div>`; }
        function registarParto() {
            const np=parseInt(document.getElementById('parto-porca-num').value), gv=[], gf=[];
            document.querySelectorAll('.leitao-vender-genero').forEach(s=>gv.push(s.value));
            document.querySelectorAll('.leitao-ficar-genero').forEach(s=>gf.push(s.value));
            if (gv.length===0&&gf.length===0) { alert('Adiciona leit√µes!'); return; }
            const i=dados.porcas.findIndex(x=>x.num===np); if(i===-1)return;
            const p=dados.porcas[i], pai=p.ultimoVarrao, dd=adicionarDias(hoje(),28);
            dados.porcas[i].estado={tipo:'Amamentacao',dataDesmame:dd}; dados.porcas[i].numPartos+=1; dados.porcas[i].pocilga='Parideiras';
            gv.forEach(g=>dados.leitoes.push({idLeitao:dados.proximoIdLeitao++,maeId:np,paiId:pai,genero:g,destino:'Vender',dataLeitaoNasc:hoje()}));
            gf.forEach(g=>dados.leitoes.push({idLeitao:dados.proximoIdLeitao++,maeId:np,paiId:pai,genero:g,destino:'Ficar',dataLeitaoNasc:hoje(),numeroAtribuido:false}));
            dados.historico.unshift({data:hoje(),tipo:'EventoParto',descricao:`Porca ${np} pariu ${gv.length+gf.length} leit√µes`,numPorca:np,numVarrao:pai});
            guardarDados().then(()=>{fecharModal('modal-parto');alert(`Parto! Desmame: ${formatarData(dd)}`);});
        }

        function abrirModalDesmame(n) {
            document.getElementById('desmame-porca-num').value=n;
            const lf = dados.leitoes.filter(l=>l.maeId===n&&l.destino==='Ficar');
            const c = document.getElementById('desmame-leitoes-container');
            c.innerHTML = lf.length===0 ? '<p style="color:#666;">Sem leit√µes para ficar.</p>' : lf.map(l=>`<div class="leitao-item"><span>${l.genero==='Macho'?'‚ôÇ':'‚ôÄ'} #${l.idLeitao}</span><span>‚Üí ${l.genero==='Femea'?'Porca':'Varr√£o'} n¬∫:</span><input type="number" class="desmame-numero" data-id="${l.idLeitao}" data-genero="${l.genero}" style="width:70px;"></div>`).join('');
            fecharModal('modal-porca'); document.getElementById('modal-desmame').classList.add('active');
        }
        function confirmarDesmame() {
            const np=parseInt(document.getElementById('desmame-porca-num').value), novos=[];
            for (const inp of document.querySelectorAll('.desmame-numero')) {
                const num=parseInt(inp.value), id=parseInt(inp.dataset.id), g=inp.dataset.genero;
                if (!num) { alert(`N√∫mero para leit√£o #${id}!`); return; }
                if (g==='Femea' && dados.porcas.find(p=>p.num===num)) { alert(`Porca ${num} j√° existe!`); return; }
                if (g==='Macho' && dados.varroes.find(v=>v.numVarrao===num)) { alert(`Varr√£o ${num} j√° existe!`); return; }
                novos.push({id,num,g});
            }
            const i=dados.porcas.findIndex(x=>x.num===np); if(i===-1)return;
            dados.porcas[i].estado={tipo:'Recuperacao',dataFim:adicionarDias(hoje(),8)}; dados.porcas[i].pocilga='Cobricao';
            novos.forEach(({id,num,g})=>{
                const l=dados.leitoes.find(x=>x.idLeitao===id);
                if(g==='Femea') dados.porcas.push({num,pocilga:'Cima',estado:'Jovem',numPartos:0,dataNascimento:l?.dataLeitaoNasc||hoje(),ultimoVarrao:null});
                else dados.varroes.push({numVarrao:num,estado:'Jovem',dataNascVarrao:l?.dataLeitaoNasc||hoje()});
            });
            dados.leitoes=dados.leitoes.filter(l=>l.maeId!==np);
            dados.historico.unshift({data:hoje(),tipo:'EventoDesmame',descricao:`Porca ${np} desmamada - ${novos.length} promovidos`,numPorca:np});
            guardarDados().then(()=>{fecharModal('modal-desmame');alert(`Desmame! ${novos.length} novos animais.`);});
        }

        function renderizarVarroes() {
            const c = document.getElementById('lista-varroes');
            if (dados.varroes.length===0) { c.innerHTML='<div class="empty"><span>üêó</span>Nenhum varr√£o</div>'; return; }
            c.innerHTML = dados.varroes.map(v=>{ const e=getEstadoVarraoLabel(v); return `<div class="card" onclick="abrirModalVarrao(${v.numVarrao})"><div class="card-title">Varr√£o #${v.numVarrao}</div><div class="card-info"><span class="badge ${e.classe}">${e.texto}</span>${v.dataNascVarrao?`<br><small>Nasc: ${formatarData(v.dataNascVarrao)}</small>`:''}</div></div>`; }).join('');
        }
        function abrirModalNovoVarrao() { document.getElementById('novo-varrao-num').value=''; document.getElementById('novo-varrao-estado').value='Jovem'; document.getElementById('novo-varrao-data').value=''; document.getElementById('modal-novo-varrao').classList.add('active'); }
        function adicionarVarrao() {
            const n=parseInt(document.getElementById('novo-varrao-num').value), e=document.getElementById('novo-varrao-estado').value, d=document.getElementById('novo-varrao-data').value||null;
            if (!n) { alert('Introduz n√∫mero'); return; }
            if (dados.varroes.find(x=>x.numVarrao===n)) { alert('J√° existe'); return; }
            dados.varroes.push({numVarrao:n,estado:e,dataNascVarrao:d});
            dados.historico.unshift({data:hoje(),tipo:'EventoAdicionar',descricao:`Varr√£o ${n} adicionado (${e})`,numVarrao:n});
            guardarDados().then(()=>{fecharModal('modal-novo-varrao');alert('Varr√£o adicionado!');});
        }
        function abrirModalVarrao(n) {
            const v=dados.varroes.find(x=>x.numVarrao===n); if(!v)return;
            const e=getEstadoVarraoLabel(v);
            document.getElementById('modal-varrao-titulo').textContent=`Varr√£o #${v.numVarrao}`;
            document.getElementById('modal-varrao-info').innerHTML=`<div class="card"><p><strong>Estado:</strong> <span class="badge ${e.classe}">${e.texto}</span></p>${v.dataNascVarrao?`<p><strong>Nasc:</strong> ${formatarData(v.dataNascVarrao)}</p>`:''}</div>`;
            let a = v.estado==='Jovem' ? `<button class="btn btn-success" onclick="tornarVarraoDisponivel(${n})">Tornar Dispon√≠vel</button>` : '';
            a+=`<button class="btn btn-danger" onclick="removerVarrao(${n})">Remover</button>`;
            document.getElementById('modal-varrao-acoes').innerHTML=a;
            document.getElementById('modal-varrao').classList.add('active');
        }
        function tornarVarraoDisponivel(n) { const i=dados.varroes.findIndex(x=>x.numVarrao===n); if(i===-1)return; dados.varroes[i].estado='Disponivel'; dados.historico.unshift({data:hoje(),tipo:'EventoDisponivel',descricao:`Varr√£o ${n} dispon√≠vel`,numVarrao:n}); guardarDados().then(()=>{fecharModal('modal-varrao');alert('Dispon√≠vel!');}); }
        function removerVarrao(n) { if(!confirm(`Remover Varr√£o ${n}?`))return; dados.varroes=dados.varroes.filter(x=>x.numVarrao!==n); dados.historico.unshift({data:hoje(),tipo:'EventoMatadouro',descricao:`Varr√£o ${n} removido`,numVarrao:n}); guardarDados().then(()=>{fecharModal('modal-varrao');alert('Removido.');}); }

        function renderizarLeitoes() {
            const c = document.getElementById('lista-leitoes');
            if (dados.leitoes.length===0) { c.innerHTML='<div class="empty"><span>üêΩ</span>Nenhum leit√£o</div>'; document.getElementById('btn-vender-leitoes').style.display='none'; return; }
            c.innerHTML = dados.leitoes.map(l=>{ const sn=l.destino==='Ficar'&&!l.numeroAtribuido; return `<div class="leitao-card ${sn?'sem-numero':''}"><span class="leitao-genero">${l.genero==='Macho'?'‚ôÇ':'‚ôÄ'}</span><div class="leitao-info"><strong>Leit√£o #${l.idLeitao}</strong>${sn?'<span class="badge badge-sem-numero">Sem n¬∫</span>':''}<br><small>M√£e: ${l.maeId} ‚Ä¢ ${l.destino==='Vender'?'üí∞ Vender':'üè† Ficar'}</small><br><small>Nasc: ${formatarData(l.dataLeitaoNasc)}</small></div>${l.destino==='Vender'?`<input type="checkbox" class="leitao-checkbox" value="${l.idLeitao}" onchange="toggleLeitaoSelecionado(${l.idLeitao})">`:''}${sn?`<button class="btn-alerta purple" onclick="abrirModalAtribuirNumero(${l.idLeitao})" style="margin:0;padding:8px;">Atribuir</button>`:''}</div>`; }).join('');
            atualizarBotaoVender();
        }
        function toggleLeitaoSelecionado(id) { const i=leitoesSelecionados.indexOf(id); if(i===-1)leitoesSelecionados.push(id); else leitoesSelecionados.splice(i,1); atualizarBotaoVender(); }
        function atualizarBotaoVender() { const b=document.getElementById('btn-vender-leitoes'); b.style.display=leitoesSelecionados.length>0?'block':'none'; b.textContent=`üí∞ Vender ${leitoesSelecionados.length}`; }
        function abrirModalVenderLeitoes() { document.getElementById('vender-leitoes-info').textContent=`Vender ${leitoesSelecionados.length} leit√£o(√µes)?`; document.getElementById('vender-leitoes-valor').value=''; document.getElementById('modal-vender-leitoes').classList.add('active'); }
        function confirmarVendaLeitoes() { const v=parseFloat(document.getElementById('vender-leitoes-valor').value)||0; dados.leitoes=dados.leitoes.filter(l=>!leitoesSelecionados.includes(l.idLeitao)); dados.historico.unshift({data:hoje(),tipo:'EventoVenda',descricao:`Vendidos ${leitoesSelecionados.length} leit√µes por ‚Ç¨${v.toFixed(2)}`,valor:v}); leitoesSelecionados=[]; guardarDados().then(()=>{fecharModal('modal-vender-leitoes');alert(`Venda: ‚Ç¨${v.toFixed(2)}`);}); }

        function abrirModalAtribuirNumero(id) {
            const l=dados.leitoes.find(x=>x.idLeitao===id); if(!l)return;
            document.getElementById('atribuir-leitao-id').value=id;
            document.getElementById('atribuir-leitao-info').innerHTML=`<p>${l.genero==='Macho'?'‚ôÇ Macho':'‚ôÄ F√™mea'} - Leit√£o #${id}</p><p>Ser√°: <strong>${l.genero==='Femea'?'Porca Jovem':'Varr√£o Jovem'}</strong></p>`;
            document.getElementById('atribuir-numero').value='';
            document.getElementById('modal-atribuir-numero').classList.add('active');
        }
        function confirmarAtribuirNumero() {
            const id=parseInt(document.getElementById('atribuir-leitao-id').value), num=parseInt(document.getElementById('atribuir-numero').value);
            if (!num) { alert('Introduz n√∫mero!'); return; }
            const l=dados.leitoes.find(x=>x.idLeitao===id); if(!l)return;
            if (l.genero==='Femea') { if(dados.porcas.find(p=>p.num===num)){alert(`Porca ${num} j√° existe!`);return;} dados.porcas.push({num,pocilga:'Cima',estado:'Jovem',numPartos:0,dataNascimento:l.dataLeitaoNasc,ultimoVarrao:null}); }
            else { if(dados.varroes.find(v=>v.numVarrao===num)){alert(`Varr√£o ${num} j√° existe!`);return;} dados.varroes.push({numVarrao:num,estado:'Jovem',dataNascVarrao:l.dataLeitaoNasc}); }
            dados.leitoes=dados.leitoes.filter(x=>x.idLeitao!==id);
            dados.historico.unshift({data:hoje(),tipo:'EventoNovoNumero',descricao:`Leit√£o #${id} ‚Üí ${l.genero==='Femea'?'Porca':'Varr√£o'} #${num}`});
            guardarDados().then(()=>{fecharModal('modal-atribuir-numero');alert(`${l.genero==='Femea'?'Porca':'Varr√£o'} #${num} criado!`);});
        }

        function renderizarDespesas() {
            const c=document.getElementById('lista-despesas'), r=dados.historico.filter(e=>e.tipo==='EventoVenda'&&e.valor).reduce((s,e)=>s+e.valor,0), d=dados.despesas.reduce((s,x)=>s+x.valorDespesa,0), l=r-d;
            document.getElementById('total-receitas').textContent=`‚Ç¨${r.toFixed(2)}`;
            document.getElementById('total-despesas').textContent=`‚Ç¨${d.toFixed(2)}`;
            document.getElementById('total-lucro').textContent=`‚Ç¨${l.toFixed(2)}`;
            document.getElementById('card-lucro').classList.toggle('negativo',l<0);
            if (dados.despesas.length===0) { c.innerHTML='<div class="empty"><span>üí∞</span>Nenhuma despesa</div>'; return; }
            c.innerHTML = [...dados.despesas].sort((a,b)=>new Date(b.dataDespesa)-new Date(a.dataDespesa)).slice(0,10).map(x=>`<div class="despesa-card"><div class="valor">‚Ç¨${x.valorDespesa.toFixed(2)}</div><div><span class="categoria">${x.categoriaDespesa}</span></div><div>${x.descricaoDespesa}</div><div class="data">${formatarData(x.dataDespesa)}</div></div>`).join('');
        }
        function abrirModalNovaDespesa() { document.getElementById('despesa-categoria').value='Alimentacao'; document.getElementById('despesa-descricao').value=''; document.getElementById('despesa-valor').value=''; document.getElementById('modal-nova-despesa').classList.add('active'); }
        function adicionarDespesa() {
            const cat=document.getElementById('despesa-categoria').value, desc=document.getElementById('despesa-descricao').value, val=parseFloat(document.getElementById('despesa-valor').value);
            if (!desc||!val) { alert('Preenche tudo'); return; }
            dados.despesas.push({idDespesa:dados.proximoIdDespesa++,dataDespesa:hoje(),categoriaDespesa:cat,descricaoDespesa:desc,valorDespesa:val});
            dados.historico.unshift({data:hoje(),tipo:'EventoDespesa',descricao:`Despesa: ${desc} - ‚Ç¨${val.toFixed(2)}`});
            guardarDados().then(()=>{fecharModal('modal-nova-despesa');alert('Despesa adicionada!');});
        }

        function renderizarStats() {
            document.getElementById('stat-total-porcas').textContent=dados.porcas.length;
            document.getElementById('stat-total-varroes').textContent=dados.varroes.length;
            document.getElementById('stat-total-leitoes').textContent=dados.leitoes.length;
            const e={Jovem:0,Disponivel:0,Gravida:0,Amamentacao:0,Recuperacao:0};
            dados.porcas.forEach(p=>{const t=p.estado?.tipo||p.estado;if(e[t]!==undefined)e[t]++;});
            const tot=dados.porcas.length||1;
            document.getElementById('barras-estados').innerHTML=`
                <div class="barra-container"><div class="barra-label"><span>Dispon√≠veis</span><span>${e.Disponivel}</span></div><div class="barra-fundo"><div class="barra-valor barra-verde" style="width:${(e.Disponivel/tot)*100}%"></div></div></div>
                <div class="barra-container"><div class="barra-label"><span>Gr√°vidas</span><span>${e.Gravida}</span></div><div class="barra-fundo"><div class="barra-valor barra-amarela" style="width:${(e.Gravida/tot)*100}%"></div></div></div>
                <div class="barra-container"><div class="barra-label"><span>Amamenta√ß√£o</span><span>${e.Amamentacao}</span></div><div class="barra-fundo"><div class="barra-valor barra-rosa" style="width:${(e.Amamentacao/tot)*100}%"></div></div></div>
                <div class="barra-container"><div class="barra-label"><span>Recupera√ß√£o</span><span>${e.Recuperacao}</span></div><div class="barra-fundo"><div class="barra-valor barra-azul" style="width:${(e.Recuperacao/tot)*100}%"></div></div></div>
                <div class="barra-container"><div class="barra-label"><span>Jovens</span><span>${e.Jovem}</span></div><div class="barra-fundo"><div class="barra-valor barra-cinza" style="width:${(e.Jovem/tot)*100}%"></div></div></div>`;
        }

        function renderizarHistorico() {
            const c=document.getElementById('lista-historico');
            if (dados.historico.length===0) { c.innerHTML='<div class="empty"><span>üìú</span>Nenhum evento</div>'; return; }
            c.innerHTML = dados.historico.slice(0,50).map(e=>{let cl='';switch(e.tipo){case'EventoAdicionar':cl='evento-adicionar';break;case'EventoCobricao':cl='evento-cobricao';break;case'EventoParto':cl='evento-parto';break;case'EventoDesmame':cl='evento-desmame';break;case'EventoMatadouro':cl='evento-matadouro';break;case'EventoVenda':cl='evento-venda';break;case'EventoDisponivel':cl='evento-disponivel';break;case'EventoRecuperacao':cl='evento-recuperacao';break;}return`<div class="card ${cl}"><div class="card-info">${formatarData(e.data)}</div><div class="card-title">${e.descricao}</div></div>`;}).join('');
        }

        function atualizarUI() { renderizarAlertas(); renderizarPorcas(); renderizarVarroes(); renderizarLeitoes(); renderizarStats(); renderizarDespesas(); renderizarHistorico(); }
        window.addEventListener('online',()=>document.getElementById('offline-banner').classList.remove('show'));
        window.addEventListener('offline',()=>document.getElementById('offline-banner').classList.add('show'));
        carregarDados();
    </script>
</body>
</html>
