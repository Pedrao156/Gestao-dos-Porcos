<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Quinta dos Porcos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f0f0; min-height: 100vh; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, #2d5016 0%, #4a7c23 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.5rem; }
        .alertas { padding: 10px; }
        .alerta { background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 8px; border-radius: 8px; }
        .alerta.urgente { background: #f8d7da; border-left-color: #dc3545; }
        .alerta.pronta { background: #d1ecf1; border-left-color: #17a2b8; }
        .alerta.recuperacao { background: #d4edda; border-left-color: #28a745; }
        .alerta.sem_cobrir { background: #ffe0b2; border-left-color: #ff9800; }
        .despesa-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #dc3545; }
        .despesa-card .valor { font-size: 1.3rem; font-weight: bold; color: #dc3545; }
        .despesa-card .categoria { font-size: 0.8rem; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; display: inline-block; }
        .despesa-card .data { font-size: 0.85rem; color: #999; }
        .financeiro-resumo { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .financeiro-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .financeiro-card.receita { border-top: 4px solid #28a745; }
        .financeiro-card.despesa { border-top: 4px solid #dc3545; }
        .financeiro-card.lucro { border-top: 4px solid #007bff; }
        .financeiro-card .valor { font-size: 1.8rem; font-weight: bold; }
        .financeiro-card.receita .valor { color: #28a745; }
        .financeiro-card.despesa .valor { color: #dc3545; }
        .financeiro-card.lucro .valor { color: #007bff; }
        .financeiro-card.lucro.negativo .valor { color: #dc3545; }
        .financeiro-card .label { font-size: 0.9rem; color: #666; margin-top: 5px; }
        .btn-alerta { margin-top: 10px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: bold; cursor: pointer; display: block; }
        .container { padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; }
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: #2d5016; }
        .card-info { color: #666; font-size: 0.9rem; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; color: white; }
        .badge-jovem { background: #6c757d; }
        .badge-disponivel { background: #28a745; }
        .badge-gravida { background: #ffc107; color: #333; }
        .badge-amamentacao { background: #e83e8c; }
        .badge-recuperacao { background: #17a2b8; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { flex: 1; padding: 10px 5px; text-align: center; border: none; background: none; cursor: pointer; color: #666; font-size: 0.65rem; }
        .nav-item.active { color: #2d5016; }
        .nav-item span { display: block; font-size: 1.2rem; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #2d5016; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-success { background: #28a745; color: white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .form-group small { color: #666; font-size: 0.8rem; display: block; margin-top: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto; }
        .modal-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .section-title { font-size: 1.2rem; font-weight: bold; margin: 20px 0 10px; color: #2d5016; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .empty span { font-size: 3rem; display: block; margin-bottom: 10px; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #2d5016; color: white; border: none; font-size: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 90; }
        .hidden { display: none !important; }
        .evento-adicionar { border-left: 4px solid #28a745; }
        .evento-cobricao { border-left: 4px solid #ffc107; }
        .evento-parto { border-left: 4px solid #e83e8c; }
        .evento-desmame { border-left: 4px solid #17a2b8; }
        .evento-matadouro { border-left: 4px solid #dc3545; }
        .evento-disponivel { border-left: 4px solid #28a745; }
        .evento-recuperacao { border-left: 4px solid #17a2b8; }
        .evento-venda { border-left: 4px solid #28a745; }
        .stat-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-titulo { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; color: #2d5016; }
        .stat-numero { font-size: 2.5rem; font-weight: bold; color: #2d5016; text-align: center; margin: 10px 0; }
        .stat-label { text-align: center; color: #666; font-size: 0.9rem; }
        .barra-container { margin: 10px 0; }
        .barra-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .barra-fundo { background: #e9ecef; border-radius: 10px; height: 25px; overflow: hidden; }
        .barra-valor { height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.8rem; font-weight: bold; min-width: 30px; }
        .barra-verde { background: #28a745; }
        .barra-amarela { background: #ffc107; color: #333; }
        .barra-rosa { background: #e83e8c; }
        .barra-azul { background: #17a2b8; }
        .barra-cinza { background: #6c757d; }
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .grid-stats .stat-card { margin-bottom: 0; }
        .filtro-container { margin-bottom: 15px; }
        .filtro-container select { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; font-size: 1rem; }
        .resumo-parto { background: #f8f9fa; border-radius: 8px; padding: 12px; margin: 15px 0; }
        .resumo-parto .linha { display: flex; justify-content: space-between; margin: 5px 0; }
        .resumo-parto .total { border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold; }
        .leitao-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .leitao-info { flex: 1; }
        .leitao-genero { font-size: 1.5rem; margin-right: 10px; }
        .leitao-checkbox { width: 24px; height: 24px; }
        .loading { text-align: center; padding: 40px; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2d5016; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .offline-banner { background: #dc3545; color: white; text-align: center; padding: 10px; display: none; }
        .offline-banner.show { display: block; }
    </style>
</head>
<body>
    <div id="offline-banner" class="offline-banner">‚ö†Ô∏è Sem liga√ß√£o √† internet</div>
    
    <div class="header">
        <h1>üê∑ Quinta dos Porcos</h1>
    </div>

    <!-- P√°gina: Alertas -->
    <div id="pagina-alertas" class="pagina">
        <div class="alertas" id="lista-alertas">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>A carregar...</p>
            </div>
        </div>
    </div>

    <!-- P√°gina: Porcas -->
    <div id="pagina-porcas" class="pagina hidden">
        <div class="container">
            <div class="filtro-container">
                <select id="filtro-porcas" onchange="filtrarPorcas()">
                    <option value="todas">Todas as porcas</option>
                    <option value="Cima">Pocilga de Cima (Jovens)</option>
                    <option value="Cobricao">Cobri√ß√£o</option>
                    <option value="Parideiras">Parideiras</option>
                    <option value="Disponivel">Dispon√≠veis</option>
                    <option value="Gravida">Gr√°vidas</option>
                    <option value="Amamentacao">Em amamenta√ß√£o</option>
                    <option value="Recuperacao">Em recupera√ß√£o</option>
                </select>
            </div>
            <div id="lista-porcas"></div>
        </div>
        <button class="fab" onclick="abrirModalNovaPorca()">+</button>
    </div>

    <!-- P√°gina: Varr√µes -->
    <div id="pagina-varroes" class="pagina hidden">
        <div class="container">
            <div id="lista-varroes"></div>
        </div>
        <button class="fab" onclick="abrirModalNovoVarrao()">+</button>
    </div>

    <!-- P√°gina: Leit√µes -->
    <div id="pagina-leitoes" class="pagina hidden">
        <div class="container">
            <div id="lista-leitoes"></div>
            <button class="btn btn-success" onclick="abrirModalVenderLeitoes()" id="btn-vender-leitoes" style="display:none;">
                üí∞ Vender Selecionados
            </button>
        </div>
    </div>

    <!-- P√°gina: Estat√≠sticas -->
    <div id="pagina-stats" class="pagina hidden">
        <div class="container">
            <div class="grid-stats">
                <div class="stat-card">
                    <div class="stat-numero" id="stat-total-porcas">0</div>
                    <div class="stat-label">Porcas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero" id="stat-total-varroes">0</div>
                    <div class="stat-label">Varr√µes</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-titulo">Estados das Porcas</div>
                <div id="barras-estados"></div>
            </div>
            <div class="stat-card">
                <div class="stat-titulo">Leit√µes</div>
                <div class="stat-numero" id="stat-total-leitoes">0</div>
                <div class="stat-label">leit√µes atualmente</div>
            </div>
        </div>
    </div>

    <!-- P√°gina: Financeiro -->
    <div id="pagina-financeiro" class="pagina hidden">
        <div class="container">
            <div class="financeiro-resumo">
                <div class="financeiro-card receita">
                    <div class="valor" id="total-receitas">‚Ç¨0</div>
                    <div class="label">Receitas</div>
                </div>
                <div class="financeiro-card despesa">
                    <div class="valor" id="total-despesas">‚Ç¨0</div>
                    <div class="label">Despesas</div>
                </div>
            </div>
            <div class="financeiro-card lucro" id="card-lucro">
                <div class="valor" id="total-lucro">‚Ç¨0</div>
                <div class="label">Lucro/Preju√≠zo</div>
            </div>
            <h3 class="section-title">Despesas Recentes</h3>
            <div id="lista-despesas"></div>
            <button class="btn btn-danger" onclick="abrirModalNovaDespesa()">+ Nova Despesa</button>
        </div>
    </div>

    <!-- P√°gina: Hist√≥rico -->
    <div id="pagina-historico" class="pagina hidden">
        <div class="container">
            <div id="lista-historico"></div>
        </div>
    </div>

    <!-- Navega√ß√£o -->
    <nav class="nav">
        <button class="nav-item active" onclick="mudarPagina('alertas')">
            <span>üîî</span>Alertas
        </button>
        <button class="nav-item" onclick="mudarPagina('porcas')">
            <span>üê∑</span>Porcas
        </button>
        <button class="nav-item" onclick="mudarPagina('varroes')">
            <span>üêó</span>Varr√µes
        </button>
        <button class="nav-item" onclick="mudarPagina('leitoes')">
            <span>üêΩ</span>Leit√µes
        </button>
        <button class="nav-item" onclick="mudarPagina('stats')">
            <span>üìä</span>Stats
        </button>
        <button class="nav-item" onclick="mudarPagina('financeiro')">
            <span>üí∞</span>‚Ç¨
        </button>
        <button class="nav-item" onclick="mudarPagina('historico')">
            <span>üìú</span>Hist√≥rico
        </button>
    </nav>

    <!-- Modal: Nova Porca -->
    <div id="modal-nova-porca" class="modal">
        <div class="modal-content">
            <div class="modal-title">Adicionar Porca</div>
            <div class="form-group">
                <label>N√∫mero da Porca</label>
                <input type="number" id="nova-porca-num" placeholder="Ex: 12">
            </div>
            <div class="form-group">
                <label>Pocilga</label>
                <select id="nova-porca-pocilga">
                    <option value="Cima">Cima (Jovem)</option>
                    <option value="Cobricao">Cobri√ß√£o (Dispon√≠vel)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Data de Nascimento (opcional)</label>
                <input type="date" id="nova-porca-data">
            </div>
            <button class="btn btn-primary" onclick="adicionarPorca()">Adicionar</button>
            <button class="btn btn-secondary" onclick="fecharModal('modal-nova-porca')">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Novo Varr√£o -->
    <div id="modal-novo-varrao" class="modal">
        <div class="modal-content">
            <div class="modal-title">Adicionar Varr√£o</div>
            <div class="form-group">
                <label>N√∫mero do Varr√£o</label>
                <input type="number" id="novo-varrao-num" placeholder="Ex: 1">
            </div>
            <div class="form-group">
                <label>Data de Nascimento (opcional)</label>
                <input type="date" id="novo-varrao-data">
            </div>
            <button class="btn btn-primary" onclick="adicionarVarrao()">Adicionar</button>
            <button class="btn btn-secondary" onclick="fecharModal('modal-novo-varrao')">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Detalhes Porca -->
    <div id="modal-porca" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-porca-titulo">Porca #</div>
            <div id="modal-porca-info"></div>
            <div id="modal-porca-acoes"></div>
            <button class="btn btn-secondary" onclick="fecharModal('modal-porca')">Fechar</button>
        </div>
    </div>

    <!-- Modal: Cobri√ß√£o -->
    <div id="modal-cobricao" class="modal">
        <div class="modal-content">
            <div class="modal-title">Registar Cobri√ß√£o</div>
            <input type="hidden" id="cobricao-porca-num">
            <div class="form-group">
                <label>Varr√£o que cobriu</label>
                <select id="cobricao-varrao"></select>
            </div>
            <button class="btn btn-warning" onclick="registarCobricao()">Registar Cobri√ß√£o</button>
            <button class="btn btn-secondary" onclick="fecharModal('modal-cobricao')">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Parto -->
    <div id="modal-parto" class="modal">
        <div class="modal-content">
            <div class="modal-title">Registar Parto</div>
            <input type="hidden" id="parto-porca-num">
            <div class="form-group">
                <label>Leit√µes para VENDER (n√£o especificados)</label>
                <input type="number" id="parto-vender" value="0" min="0">
            </div>
            <div class="form-group">
                <label>Leit√µes para FICAR</label>
                <div id="parto-ficar-container"></div>
                <button type="button" class="btn btn-info" onclick="adicionarLeitaoFicar()" style="margin-top:10px;">+ Adicionar leit√£o para ficar</button>
            </div>
            <div class="resumo-parto" id="resumo-parto"></div>
            <button class="btn btn-primary" onclick="registarParto()">Registar Parto</button>
            <button class="btn btn-secondary" onclick="fecharModal('modal-parto')">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Vender Leit√µes -->
    <div id="modal-vender-leitoes" class="modal">
        <div class="modal-content">
            <div class="modal-title">Vender Leit√µes</div>
            <p id="vender-leitoes-info"></p>
            <div class="form-group">
                <label>Valor da venda (‚Ç¨)</label>
                <input type="number" id="vender-leitoes-valor" step="0.01" placeholder="Ex: 150.00">
            </div>
            <button class="btn btn-success" onclick="confirmarVendaLeitoes()">Confirmar Venda</button>
            <button class="btn btn-secondary" onclick="fecharModal('modal-vender-leitoes')">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Nova Despesa -->
    <div id="modal-nova-despesa" class="modal">
        <div class="modal-content">
            <div class="modal-title">Nova Despesa</div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="despesa-categoria">
                    <option value="Alimentacao">Alimenta√ß√£o</option>
                    <option value="Veterinario">Veterin√°rio</option>
                    <option value="Equipamento">Equipamento</option>
                    <option value="Manutencao">Manuten√ß√£o</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <input type="text" id="despesa-descricao" placeholder="Ex: Ra√ß√£o 50kg">
            </div>
            <div class="form-group">
                <label>Valor (‚Ç¨)</label>
                <input type="number" id="despesa-valor" step="0.01" placeholder="Ex: 45.50">
            </div>
            <button class="btn btn-danger" onclick="adicionarDespesa()">Adicionar Despesa</button>
            <button class="btn btn-secondary" onclick="fecharModal('modal-nova-despesa')">Cancelar</button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURA√á√ÉO FIREBASE ====================
        // IMPORTANTE: Substitui isto com as tuas credenciais do Firebase!
        const firebaseConfig = {
            apiKey: "AIzaSyA_ToriWPqYJ3ELzzRkIXpRoyAjA3Fk5xI",
            authDomain: "gestao-dos-porcos.firebaseapp.com",
            databaseURL: "https://gestao-dos-porcos-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestao-dos-porcos",
            storageBucket: "gestao-dos-porcos.firebasestorage.app",
            messagingSenderId: "973161258767",
            appId: "1:973161258767:web:8bb5f9e6bf9bb98fae287a"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==================== DADOS GLOBAIS ====================
        let dados = {
            porcas: [],
            varroes: [],
            leitoes: [],
            historico: [],
            despesas: [],
            proximoIdLeitao: 1,
            proximoIdDespesa: 1
        };

        let leitoesSelecionados = [];

        // ==================== FUN√á√ïES DE BASE DE DADOS ====================
        function carregarDados() {
            db.ref('quinta').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    dados = {
                        porcas: val.porcas || [],
                        varroes: val.varroes || [],
                        leitoes: val.leitoes || [],
                        historico: val.historico || [],
                        despesas: val.despesas || [],
                        proximoIdLeitao: val.proximoIdLeitao || 1,
                        proximoIdDespesa: val.proximoIdDespesa || 1
                    };
                }
                atualizarUI();
            }, (error) => {
                console.error("Erro ao carregar dados:", error);
                alert("Erro ao ligar √† base de dados. Verifica a configura√ß√£o do Firebase.");
            });
        }

        function guardarDados() {
            return db.ref('quinta').set(dados);
        }

        // ==================== FUN√á√ïES DE NAVEGA√á√ÉO ====================
        function mudarPagina(pagina) {
            document.querySelectorAll('.pagina').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('pagina-' + pagina).classList.remove('hidden');
            event.target.closest('.nav-item').classList.add('active');
            
            atualizarUI();
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ==================== FUN√á√ïES DE UTILIDADE ====================
        function hoje() {
            return new Date().toISOString().split('T')[0];
        }

        function formatarData(dataStr) {
            if (!dataStr) return '-';
            const d = new Date(dataStr);
            return d.toLocaleDateString('pt-PT');
        }

        function diasEntre(data1, data2) {
            const d1 = new Date(data1);
            const d2 = new Date(data2);
            return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        function adicionarDias(dataStr, dias) {
            const d = new Date(dataStr);
            d.setDate(d.getDate() + dias);
            return d.toISOString().split('T')[0];
        }

        // ==================== ESTADOS E POCILGAS ====================
        function getEstadoLabel(porca) {
            if (!porca.estado) return { texto: 'Desconhecido', classe: 'badge-jovem' };
            
            const tipo = porca.estado.tipo || porca.estado;
            switch(tipo) {
                case 'Jovem': return { texto: 'Jovem', classe: 'badge-jovem' };
                case 'Disponivel': return { texto: 'Dispon√≠vel', classe: 'badge-disponivel' };
                case 'Gravida': return { texto: `Gr√°vida (parto: ${formatarData(porca.estado.dataParto)})`, classe: 'badge-gravida' };
                case 'Amamentacao': return { texto: `Amamenta√ß√£o (desmame: ${formatarData(porca.estado.dataDesmame)})`, classe: 'badge-amamentacao' };
                case 'Recuperacao': return { texto: `Recupera√ß√£o (at√©: ${formatarData(porca.estado.dataFim)})`, classe: 'badge-recuperacao' };
                default: return { texto: tipo, classe: 'badge-jovem' };
            }
        }

        function getPocilgaLabel(pocilga) {
            switch(pocilga) {
                case 'Cima': return 'Pocilga de Cima';
                case 'Cobricao': return 'Cobri√ß√£o';
                case 'Parideiras': return 'Parideiras';
                default: return pocilga;
            }
        }

        // ==================== ALERTAS ====================
        function gerarAlertas() {
            const alertas = [];
            const hojeStr = hoje();
            
            dados.porcas.forEach(p => {
                const estado = p.estado?.tipo || p.estado;
                
                // Porcas perto de parir
                if (estado === 'Gravida' && p.estado.dataParto) {
                    const diasParto = diasEntre(hojeStr, p.estado.dataParto);
                    if (diasParto <= 7 && diasParto >= 0) {
                        alertas.push({
                            tipo: 'parto',
                            mensagem: `Porca ${p.num} perto de parir`,
                            dias: diasParto,
                            num: p.num,
                            classe: diasParto <= 3 ? 'urgente' : ''
                        });
                    }
                }
                
                // Porcas perto de desmamar
                if (estado === 'Amamentacao' && p.estado.dataDesmame) {
                    const diasDesmame = diasEntre(hojeStr, p.estado.dataDesmame);
                    if (diasDesmame <= 7 && diasDesmame >= 0) {
                        alertas.push({
                            tipo: 'desmame',
                            mensagem: `Porca ${p.num} perto de desmamar`,
                            dias: diasDesmame,
                            num: p.num,
                            classe: diasDesmame <= 3 ? 'urgente' : ''
                        });
                    }
                }
                
                // Porcas em recupera√ß√£o perto de terminar
                if (estado === 'Recuperacao' && p.estado.dataFim) {
                    const diasRecup = diasEntre(hojeStr, p.estado.dataFim);
                    if (diasRecup <= 3 && diasRecup >= 0) {
                        alertas.push({
                            tipo: 'recuperacao',
                            mensagem: `Porca ${p.num} termina recupera√ß√£o`,
                            dias: diasRecup,
                            num: p.num,
                            classe: 'recuperacao'
                        });
                    }
                }
                
                // Porcas velhas (>=8 partos)
                if (p.numPartos >= 8) {
                    alertas.push({
                        tipo: 'velha',
                        mensagem: `Porca ${p.num} para matadouro (${p.numPartos} partos)`,
                        num: p.num,
                        classe: 'urgente'
                    });
                }
                
                // Porcas jovens prontas (8 meses)
                if (estado === 'Jovem' && p.dataNascimento) {
                    const idadeDias = diasEntre(p.dataNascimento, hojeStr);
                    if (idadeDias >= 240) { // ~8 meses
                        alertas.push({
                            tipo: 'pronta',
                            mensagem: `Porca ${p.num} pronta para reproduzir (8 meses)`,
                            num: p.num,
                            classe: 'pronta'
                        });
                    }
                }
            });
            
            return alertas;
        }

        function renderizarAlertas() {
            const container = document.getElementById('lista-alertas');
            const alertas = gerarAlertas();
            
            if (alertas.length === 0) {
                container.innerHTML = '<div class="empty"><span>‚úÖ</span>Sem alertas!</div>';
                return;
            }
            
            container.innerHTML = alertas.map(a => `
                <div class="alerta ${a.classe}">
                    <strong>${a.mensagem}</strong>
                    ${a.dias !== undefined ? `<br><small>${a.dias} dias</small>` : ''}
                    ${a.tipo === 'pronta' ? `<button class="btn-alerta" onclick="tornarDisponivel(${a.num})">Tornar Dispon√≠vel</button>` : ''}
                    ${a.tipo === 'recuperacao' ? `<button class="btn-alerta" onclick="terminarRecuperacao(${a.num})">Terminar Recupera√ß√£o</button>` : ''}
                </div>
            `).join('');
        }

        // ==================== PORCAS ====================
        function renderizarPorcas() {
            const container = document.getElementById('lista-porcas');
            const filtro = document.getElementById('filtro-porcas').value;
            
            let porcasFiltradas = dados.porcas;
            
            if (filtro !== 'todas') {
                porcasFiltradas = dados.porcas.filter(p => {
                    if (filtro === 'Cima' || filtro === 'Cobricao' || filtro === 'Parideiras') {
                        return p.pocilga === filtro;
                    }
                    const estado = p.estado?.tipo || p.estado;
                    return estado === filtro;
                });
            }
            
            if (porcasFiltradas.length === 0) {
                container.innerHTML = '<div class="empty"><span>üê∑</span>Nenhuma porca encontrada</div>';
                return;
            }
            
            container.innerHTML = porcasFiltradas.map(p => {
                const estadoInfo = getEstadoLabel(p);
                return `
                    <div class="card" onclick="abrirModalPorca(${p.num})">
                        <div class="card-title">Porca #${p.num}</div>
                        <div class="card-info">
                            <span class="badge ${estadoInfo.classe}">${estadoInfo.texto}</span>
                            <br><small>${getPocilgaLabel(p.pocilga)} ‚Ä¢ ${p.numPartos} partos</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarPorcas() {
            renderizarPorcas();
        }

        function abrirModalNovaPorca() {
            document.getElementById('nova-porca-num').value = '';
            document.getElementById('nova-porca-pocilga').value = 'Cima';
            document.getElementById('nova-porca-data').value = '';
            document.getElementById('modal-nova-porca').classList.add('active');
        }

        function adicionarPorca() {
            const num = parseInt(document.getElementById('nova-porca-num').value);
            const pocilga = document.getElementById('nova-porca-pocilga').value;
            const dataNasc = document.getElementById('nova-porca-data').value || null;
            
            if (!num) {
                alert('Introduz o n√∫mero da porca');
                return;
            }
            
            if (dados.porcas.find(p => p.num === num)) {
                alert('J√° existe uma porca com esse n√∫mero');
                return;
            }
            
            const novaPorca = {
                num: num,
                pocilga: pocilga,
                estado: pocilga === 'Cima' ? 'Jovem' : 'Disponivel',
                numPartos: 0,
                dataNascimento: dataNasc,
                ultimoVarrao: null
            };
            
            dados.porcas.push(novaPorca);
            
            // Adicionar evento ao hist√≥rico
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoAdicionar',
                descricao: `Porca ${num} adicionada`,
                numPorca: num
            });
            
            guardarDados().then(() => {
                fecharModal('modal-nova-porca');
                alert('Porca adicionada!');
            });
        }

        function abrirModalPorca(num) {
            const porca = dados.porcas.find(p => p.num === num);
            if (!porca) return;
            
            const estadoInfo = getEstadoLabel(porca);
            const estadoTipo = porca.estado?.tipo || porca.estado;
            
            document.getElementById('modal-porca-titulo').textContent = `Porca #${porca.num}`;
            
            document.getElementById('modal-porca-info').innerHTML = `
                <div class="card">
                    <p><strong>Pocilga:</strong> ${getPocilgaLabel(porca.pocilga)}</p>
                    <p><strong>Estado:</strong> <span class="badge ${estadoInfo.classe}">${estadoInfo.texto}</span></p>
                    <p><strong>Partos:</strong> ${porca.numPartos}</p>
                    ${porca.dataNascimento ? `<p><strong>Nascimento:</strong> ${formatarData(porca.dataNascimento)}</p>` : ''}
                    ${porca.ultimoVarrao ? `<p><strong>√öltimo varr√£o:</strong> #${porca.ultimoVarrao}</p>` : ''}
                </div>
            `;
            
            let acoes = '';
            
            if (estadoTipo === 'Jovem') {
                acoes += `<button class="btn btn-success" onclick="tornarDisponivel(${num})">Tornar Dispon√≠vel</button>`;
            }
            
            if (estadoTipo === 'Disponivel') {
                acoes += `<button class="btn btn-warning" onclick="abrirModalCobricao(${num})">Registar Cobri√ß√£o</button>`;
            }
            
            if (estadoTipo === 'Gravida') {
                acoes += `<button class="btn btn-primary" onclick="abrirModalParto(${num})">Registar Parto</button>`;
            }
            
            if (estadoTipo === 'Amamentacao') {
                acoes += `<button class="btn btn-info" onclick="registarDesmame(${num})">Registar Desmame</button>`;
            }
            
            if (estadoTipo === 'Recuperacao') {
                acoes += `<button class="btn btn-success" onclick="terminarRecuperacao(${num})">Terminar Recupera√ß√£o</button>`;
            }
            
            acoes += `<button class="btn btn-danger" onclick="removerPorca(${num})">Enviar para Matadouro</button>`;
            
            document.getElementById('modal-porca-acoes').innerHTML = acoes;
            document.getElementById('modal-porca').classList.add('active');
        }

        function tornarDisponivel(num) {
            const idx = dados.porcas.findIndex(p => p.num === num);
            if (idx === -1) return;
            
            dados.porcas[idx].estado = 'Disponivel';
            dados.porcas[idx].pocilga = 'Cobricao';
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoDisponivel',
                descricao: `Porca ${num} dispon√≠vel para reprodu√ß√£o`,
                numPorca: num
            });
            
            guardarDados().then(() => {
                fecharModal('modal-porca');
                alert('Porca agora dispon√≠vel!');
            });
        }

        function terminarRecuperacao(num) {
            const idx = dados.porcas.findIndex(p => p.num === num);
            if (idx === -1) return;
            
            dados.porcas[idx].estado = 'Disponivel';
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoRecuperacao',
                descricao: `Porca ${num} recuperada - dispon√≠vel`,
                numPorca: num
            });
            
            guardarDados().then(() => {
                fecharModal('modal-porca');
                alert('Porca recuperada!');
            });
        }

        // ==================== COBRI√á√ÉO ====================
        function abrirModalCobricao(num) {
            document.getElementById('cobricao-porca-num').value = num;
            
            const select = document.getElementById('cobricao-varrao');
            select.innerHTML = dados.varroes.map(v => 
                `<option value="${v.numVarrao}">Varr√£o #${v.numVarrao}</option>`
            ).join('');
            
            if (dados.varroes.length === 0) {
                alert('Adiciona primeiro um varr√£o!');
                return;
            }
            
            fecharModal('modal-porca');
            document.getElementById('modal-cobricao').classList.add('active');
        }

        function registarCobricao() {
            const numPorca = parseInt(document.getElementById('cobricao-porca-num').value);
            const numVarrao = parseInt(document.getElementById('cobricao-varrao').value);
            
            const idx = dados.porcas.findIndex(p => p.num === numPorca);
            if (idx === -1) return;
            
            const dataParto = adicionarDias(hoje(), 114); // 3 meses, 3 semanas, 3 dias
            
            dados.porcas[idx].estado = {
                tipo: 'Gravida',
                dataParto: dataParto,
                varrao: numVarrao
            };
            dados.porcas[idx].ultimoVarrao = numVarrao;
            dados.porcas[idx].pocilga = 'Cobricao';
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoCobricao',
                descricao: `Porca ${numPorca} coberta por Varr√£o ${numVarrao}`,
                numPorca: numPorca,
                numVarrao: numVarrao
            });
            
            guardarDados().then(() => {
                fecharModal('modal-cobricao');
                alert(`Cobri√ß√£o registada! Parto previsto: ${formatarData(dataParto)}`);
            });
        }

        // ==================== PARTO ====================
        function abrirModalParto(num) {
            document.getElementById('parto-porca-num').value = num;
            document.getElementById('parto-vender').value = 0;
            document.getElementById('parto-ficar-container').innerHTML = '';
            atualizarResumoParto();
            
            fecharModal('modal-porca');
            document.getElementById('modal-parto').classList.add('active');
        }

        function adicionarLeitaoFicar() {
            const container = document.getElementById('parto-ficar-container');
            const idx = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>Leit√£o ${idx + 1}</label>
                <select class="leitao-genero">
                    <option value="Macho">‚ôÇ Macho</option>
                    <option value="Femea">‚ôÄ F√™mea</option>
                </select>
            `;
            container.appendChild(div);
            atualizarResumoParto();
        }

        function atualizarResumoParto() {
            const vender = parseInt(document.getElementById('parto-vender').value) || 0;
            const ficar = document.getElementById('parto-ficar-container').children.length;
            const total = vender + ficar;
            
            document.getElementById('resumo-parto').innerHTML = `
                <div class="linha"><span>Para vender:</span><span>${vender}</span></div>
                <div class="linha"><span>Para ficar:</span><span>${ficar}</span></div>
                <div class="linha total"><span>Total:</span><span>${total}</span></div>
            `;
        }

        document.getElementById('parto-vender').addEventListener('input', atualizarResumoParto);

        function registarParto() {
            const numPorca = parseInt(document.getElementById('parto-porca-num').value);
            const vender = parseInt(document.getElementById('parto-vender').value) || 0;
            
            const generos = [];
            document.querySelectorAll('.leitao-genero').forEach(sel => {
                generos.push(sel.value);
            });
            
            const idx = dados.porcas.findIndex(p => p.num === numPorca);
            if (idx === -1) return;
            
            const porca = dados.porcas[idx];
            const paiId = porca.ultimoVarrao;
            const dataDesmame = adicionarDias(hoje(), 28); // 4 semanas
            
            // Atualizar porca
            dados.porcas[idx].estado = {
                tipo: 'Amamentacao',
                dataDesmame: dataDesmame
            };
            dados.porcas[idx].numPartos += 1;
            dados.porcas[idx].pocilga = 'Parideiras';
            
            // Criar leit√µes para vender
            for (let i = 0; i < vender; i++) {
                dados.leitoes.push({
                    idLeitao: dados.proximoIdLeitao++,
                    maeId: numPorca,
                    paiId: paiId,
                    genero: 'Macho', // Default
                    destino: 'Vender',
                    dataLeitaoNasc: hoje()
                });
            }
            
            // Criar leit√µes para ficar
            generos.forEach(g => {
                dados.leitoes.push({
                    idLeitao: dados.proximoIdLeitao++,
                    maeId: numPorca,
                    paiId: paiId,
                    genero: g,
                    destino: 'Ficar',
                    dataLeitaoNasc: hoje()
                });
            });
            
            const totalLeitoes = vender + generos.length;
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoParto',
                descricao: `Porca ${numPorca} pariu ${totalLeitoes} leit√µes`,
                numPorca: numPorca,
                numVarrao: paiId
            });
            
            guardarDados().then(() => {
                fecharModal('modal-parto');
                alert(`Parto registado! ${totalLeitoes} leit√µes. Desmame previsto: ${formatarData(dataDesmame)}`);
            });
        }

        // ==================== DESMAME ====================
        function registarDesmame(num) {
            if (!confirm(`Registar desmame da Porca ${num}?`)) return;
            
            const idx = dados.porcas.findIndex(p => p.num === num);
            if (idx === -1) return;
            
            const dataFimRecup = adicionarDias(hoje(), 8);
            
            dados.porcas[idx].estado = {
                tipo: 'Recuperacao',
                dataFim: dataFimRecup
            };
            
            // Remover leit√µes desta porca
            dados.leitoes = dados.leitoes.filter(l => l.maeId !== num);
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoDesmame',
                descricao: `Porca ${num} desmamada - em recupera√ß√£o 8 dias`,
                numPorca: num
            });
            
            guardarDados().then(() => {
                fecharModal('modal-porca');
                alert('Desmame registado!');
            });
        }

        // ==================== REMOVER PORCA ====================
        function removerPorca(num) {
            if (!confirm(`Enviar Porca ${num} para o matadouro?`)) return;
            
            dados.porcas = dados.porcas.filter(p => p.num !== num);
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoMatadouro',
                descricao: `Porca ${num} enviada para matadouro`,
                numPorca: num
            });
            
            guardarDados().then(() => {
                fecharModal('modal-porca');
                alert('Porca removida.');
            });
        }

        // ==================== VARR√ïES ====================
        function renderizarVarroes() {
            const container = document.getElementById('lista-varroes');
            
            if (dados.varroes.length === 0) {
                container.innerHTML = '<div class="empty"><span>üêó</span>Nenhum varr√£o</div>';
                return;
            }
            
            container.innerHTML = dados.varroes.map(v => `
                <div class="card">
                    <div class="card-title">Varr√£o #${v.numVarrao}</div>
                    <div class="card-info">
                        ${v.dataNascVarrao ? `Nascimento: ${formatarData(v.dataNascVarrao)}` : ''}
                    </div>
                    <button class="btn btn-danger" onclick="removerVarrao(${v.numVarrao})" style="margin-top:10px;">Remover</button>
                </div>
            `).join('');
        }

        function abrirModalNovoVarrao() {
            document.getElementById('novo-varrao-num').value = '';
            document.getElementById('novo-varrao-data').value = '';
            document.getElementById('modal-novo-varrao').classList.add('active');
        }

        function adicionarVarrao() {
            const num = parseInt(document.getElementById('novo-varrao-num').value);
            const dataNasc = document.getElementById('novo-varrao-data').value || null;
            
            if (!num) {
                alert('Introduz o n√∫mero do varr√£o');
                return;
            }
            
            if (dados.varroes.find(v => v.numVarrao === num)) {
                alert('J√° existe um varr√£o com esse n√∫mero');
                return;
            }
            
            dados.varroes.push({
                numVarrao: num,
                dataNascVarrao: dataNasc
            });
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoAdicionar',
                descricao: `Varr√£o ${num} adicionado`,
                numVarrao: num
            });
            
            guardarDados().then(() => {
                fecharModal('modal-novo-varrao');
                alert('Varr√£o adicionado!');
            });
        }

        function removerVarrao(num) {
            if (!confirm(`Remover Varr√£o ${num}?`)) return;
            
            dados.varroes = dados.varroes.filter(v => v.numVarrao !== num);
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoMatadouro',
                descricao: `Varr√£o ${num} removido`,
                numVarrao: num
            });
            
            guardarDados().then(() => {
                alert('Varr√£o removido.');
            });
        }

        // ==================== LEIT√ïES ====================
        function renderizarLeitoes() {
            const container = document.getElementById('lista-leitoes');
            
            if (dados.leitoes.length === 0) {
                container.innerHTML = '<div class="empty"><span>üêΩ</span>Nenhum leit√£o</div>';
                document.getElementById('btn-vender-leitoes').style.display = 'none';
                return;
            }
            
            container.innerHTML = dados.leitoes.map(l => `
                <div class="leitao-card">
                    <span class="leitao-genero">${l.genero === 'Macho' ? '‚ôÇ' : '‚ôÄ'}</span>
                    <div class="leitao-info">
                        <strong>Leit√£o #${l.idLeitao}</strong>
                        <br><small>M√£e: Porca ${l.maeId} ‚Ä¢ ${l.destino === 'Vender' ? 'üí∞ Vender' : 'üè† Ficar'}</small>
                        <br><small>Nasc: ${formatarData(l.dataLeitaoNasc)}</small>
                    </div>
                    <input type="checkbox" class="leitao-checkbox" value="${l.idLeitao}" onchange="toggleLeitaoSelecionado(${l.idLeitao})">
                </div>
            `).join('');
            
            atualizarBotaoVender();
        }

        function toggleLeitaoSelecionado(id) {
            const idx = leitoesSelecionados.indexOf(id);
            if (idx === -1) {
                leitoesSelecionados.push(id);
            } else {
                leitoesSelecionados.splice(idx, 1);
            }
            atualizarBotaoVender();
        }

        function atualizarBotaoVender() {
            const btn = document.getElementById('btn-vender-leitoes');
            btn.style.display = leitoesSelecionados.length > 0 ? 'block' : 'none';
            btn.textContent = `üí∞ Vender ${leitoesSelecionados.length} Selecionado(s)`;
        }

        function abrirModalVenderLeitoes() {
            document.getElementById('vender-leitoes-info').textContent = 
                `Vender ${leitoesSelecionados.length} leit√£o(√µes)?`;
            document.getElementById('vender-leitoes-valor').value = '';
            document.getElementById('modal-vender-leitoes').classList.add('active');
        }

        function confirmarVendaLeitoes() {
            const valor = parseFloat(document.getElementById('vender-leitoes-valor').value) || 0;
            
            // Remover leit√µes vendidos
            dados.leitoes = dados.leitoes.filter(l => !leitoesSelecionados.includes(l.idLeitao));
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoVenda',
                descricao: `Vendidos ${leitoesSelecionados.length} leit√µes por ‚Ç¨${valor.toFixed(2)}`,
                valor: valor
            });
            
            leitoesSelecionados = [];
            
            guardarDados().then(() => {
                fecharModal('modal-vender-leitoes');
                alert(`Venda registada: ‚Ç¨${valor.toFixed(2)}`);
            });
        }

        // ==================== DESPESAS ====================
        function renderizarDespesas() {
            const container = document.getElementById('lista-despesas');
            
            // Calcular totais
            const receitas = dados.historico
                .filter(e => e.tipo === 'EventoVenda' && e.valor)
                .reduce((sum, e) => sum + e.valor, 0);
            
            const despesasTotal = dados.despesas.reduce((sum, d) => sum + d.valorDespesa, 0);
            const lucro = receitas - despesasTotal;
            
            document.getElementById('total-receitas').textContent = `‚Ç¨${receitas.toFixed(2)}`;
            document.getElementById('total-despesas').textContent = `‚Ç¨${despesasTotal.toFixed(2)}`;
            document.getElementById('total-lucro').textContent = `‚Ç¨${lucro.toFixed(2)}`;
            
            const cardLucro = document.getElementById('card-lucro');
            if (lucro < 0) {
                cardLucro.classList.add('negativo');
            } else {
                cardLucro.classList.remove('negativo');
            }
            
            if (dados.despesas.length === 0) {
                container.innerHTML = '<div class="empty"><span>üí∞</span>Nenhuma despesa registada</div>';
                return;
            }
            
            const despesasOrdenadas = [...dados.despesas].sort((a, b) => 
                new Date(b.dataDespesa) - new Date(a.dataDespesa)
            );
            
            container.innerHTML = despesasOrdenadas.slice(0, 10).map(d => `
                <div class="despesa-card">
                    <div class="valor">‚Ç¨${d.valorDespesa.toFixed(2)}</div>
                    <div><span class="categoria">${d.categoriaDespesa}</span></div>
                    <div>${d.descricaoDespesa}</div>
                    <div class="data">${formatarData(d.dataDespesa)}</div>
                </div>
            `).join('');
        }

        function abrirModalNovaDespesa() {
            document.getElementById('despesa-categoria').value = 'Alimentacao';
            document.getElementById('despesa-descricao').value = '';
            document.getElementById('despesa-valor').value = '';
            document.getElementById('modal-nova-despesa').classList.add('active');
        }

        function adicionarDespesa() {
            const categoria = document.getElementById('despesa-categoria').value;
            const descricao = document.getElementById('despesa-descricao').value;
            const valor = parseFloat(document.getElementById('despesa-valor').value);
            
            if (!descricao || !valor) {
                alert('Preenche todos os campos');
                return;
            }
            
            dados.despesas.push({
                idDespesa: dados.proximoIdDespesa++,
                dataDespesa: hoje(),
                categoriaDespesa: categoria,
                descricaoDespesa: descricao,
                valorDespesa: valor
            });
            
            dados.historico.unshift({
                data: hoje(),
                tipo: 'EventoDespesa',
                descricao: `Despesa: ${descricao} - ‚Ç¨${valor.toFixed(2)}`
            });
            
            guardarDados().then(() => {
                fecharModal('modal-nova-despesa');
                alert('Despesa adicionada!');
            });
        }

        // ==================== ESTAT√çSTICAS ====================
        function renderizarStats() {
            document.getElementById('stat-total-porcas').textContent = dados.porcas.length;
            document.getElementById('stat-total-varroes').textContent = dados.varroes.length;
            document.getElementById('stat-total-leitoes').textContent = dados.leitoes.length;
            
            // Contar estados
            const estados = { Jovem: 0, Disponivel: 0, Gravida: 0, Amamentacao: 0, Recuperacao: 0 };
            dados.porcas.forEach(p => {
                const estado = p.estado?.tipo || p.estado;
                if (estados[estado] !== undefined) {
                    estados[estado]++;
                }
            });
            
            const total = dados.porcas.length || 1;
            const barras = document.getElementById('barras-estados');
            
            barras.innerHTML = `
                <div class="barra-container">
                    <div class="barra-label"><span>Dispon√≠veis</span><span>${estados.Disponivel}</span></div>
                    <div class="barra-fundo"><div class="barra-valor barra-verde" style="width: ${(estados.Disponivel/total)*100}%"></div></div>
                </div>
                <div class="barra-container">
                    <div class="barra-label"><span>Gr√°vidas</span><span>${estados.Gravida}</span></div>
                    <div class="barra-fundo"><div class="barra-valor barra-amarela" style="width: ${(estados.Gravida/total)*100}%"></div></div>
                </div>
                <div class="barra-container">
                    <div class="barra-label"><span>Amamenta√ß√£o</span><span>${estados.Amamentacao}</span></div>
                    <div class="barra-fundo"><div class="barra-valor barra-rosa" style="width: ${(estados.Amamentacao/total)*100}%"></div></div>
                </div>
                <div class="barra-container">
                    <div class="barra-label"><span>Recupera√ß√£o</span><span>${estados.Recuperacao}</span></div>
                    <div class="barra-fundo"><div class="barra-valor barra-azul" style="width: ${(estados.Recuperacao/total)*100}%"></div></div>
                </div>
                <div class="barra-container">
                    <div class="barra-label"><span>Jovens</span><span>${estados.Jovem}</span></div>
                    <div class="barra-fundo"><div class="barra-valor barra-cinza" style="width: ${(estados.Jovem/total)*100}%"></div></div>
                </div>
            `;
        }

        // ==================== HIST√ìRICO ====================
        function renderizarHistorico() {
            const container = document.getElementById('lista-historico');
            
            if (dados.historico.length === 0) {
                container.innerHTML = '<div class="empty"><span>üìú</span>Nenhum evento registado</div>';
                return;
            }
            
            container.innerHTML = dados.historico.slice(0, 50).map(e => {
                let classe = '';
                switch(e.tipo) {
                    case 'EventoAdicionar': classe = 'evento-adicionar'; break;
                    case 'EventoCobricao': classe = 'evento-cobricao'; break;
                    case 'EventoParto': classe = 'evento-parto'; break;
                    case 'EventoDesmame': classe = 'evento-desmame'; break;
                    case 'EventoMatadouro': classe = 'evento-matadouro'; break;
                    case 'EventoVenda': classe = 'evento-venda'; break;
                    case 'EventoDisponivel': classe = 'evento-disponivel'; break;
                    case 'EventoRecuperacao': classe = 'evento-recuperacao'; break;
                }
                return `
                    <div class="card ${classe}">
                        <div class="card-info">${formatarData(e.data)}</div>
                        <div class="card-title">${e.descricao}</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== ATUALIZAR UI ====================
        function atualizarUI() {
            renderizarAlertas();
            renderizarPorcas();
            renderizarVarroes();
            renderizarLeitoes();
            renderizarStats();
            renderizarDespesas();
            renderizarHistorico();
        }

        // ==================== VERIFICAR CONEX√ÉO ====================
        window.addEventListener('online', () => {
            document.getElementById('offline-banner').classList.remove('show');
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offline-banner').classList.add('show');
        });

        // ==================== INICIAR ====================
        carregarDados();
    </script>
</body>
</html>
